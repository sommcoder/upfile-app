var n=class{dropzoneBlock=null;fileViewerBlock=null;hiddenInput=null;productForm=null;cartRoot=null;dropzoneFileInput=null;dropzoneHelpText=null;dropzoneText=null;dropzoneSelectBtn=null;dropzoneFileSizeTally=null;dropzoneFileSizeMax=null;fileViewerList=null;fileViewerOriginalRow=null;fileViewerTrashIcon=null;fileViewerStatus=null;loadingSpinner=null;fileViewerPlaceholder=null;fileViewerErrorList=null;fileViewerErrorItem=null;constructor(){if(console.log("app block constructing..."),console.log("self.upfile.settings.cartInjectionRootSelector:",self.upfile.settings.cartInjectionRootSelector),self.upfile.cart?this.cartRoot=document.querySelector(self.upfile.settings.cartInjectionRootSelector||'[id*="cart" i]'):this.productForm=document.querySelector('[data-type="add-to-cart-form"]')||document.querySelector('form[action*="/cart/add"]')||document.querySelector('form[action^="/cart"]')||null,this.dropzoneBlock=document.querySelector("#upfile__dropzone"),this.fileViewerBlock=document.getElementById("upfile__fileviewer"),this.dropzoneBlock&&this.fileViewerBlock&&this.productForm){if(this.dropzoneFileInput=this.dropzoneBlock.querySelector("#upfile__dropzone_manual_file_input"),this.dropzoneHelpText=this.dropzoneBlock.querySelector("#upfile__dropzone_help_text"),this.dropzoneText=this.dropzoneBlock.querySelector("#upfile__dropzone_text"),console.log("this.dropzoneText:",this.dropzoneText),this.dropzoneSelectBtn=this.dropzoneBlock.querySelector("#upfile__dropzone_select_file_btn"),this.dropzoneFileSizeTally=this.dropzoneBlock.querySelector("#upfile__dropzone_file_size_tally"),this.dropzoneFileSizeMax=this.dropzoneBlock.querySelector("#upfile__dropzone_file_size_max"),this.fileViewerList=this.fileViewerBlock.querySelector("#upfile__fileviewer_item_list"),!this.fileViewerList)return;this.fileViewerOriginalRow=this.fileViewerList.querySelector(".upfile__fileviewer_item_row"),this.fileViewerTrashIcon=this.fileViewerList?.querySelector(".upfile__fileviewer_trash_icon"),this.fileViewerStatus=this.fileViewerList.querySelector(".upfile__fileviewer_item_status"),this.loadingSpinner=this.fileViewerList.querySelector(".upfile__spinner"),this.fileViewerPlaceholder=this.fileViewerList.querySelector("#upfile__fileviewer_placeholder"),this.fileViewerErrorList=this.fileViewerBlock.querySelector("#upfile__fileviewer_error_list"),this.fileViewerErrorItem=this.fileViewerBlock.querySelector(".upfile__fileviewer_error_item"),this.initEventListeners(),this.isInAppBrowser()}else{let e=this.dropzoneBlock?.querySelector("#upfile__dropzone_missing_block_notice");if(e instanceof HTMLElement){if(e.style.display="flex",!this.dropzoneBlock)return;let i=this.dropzoneBlock.firstElementChild;i instanceof HTMLElement&&(i.style.display="none")}let t=this.fileViewerBlock?.querySelector("#upfile__dropzone_missing_block_notice");if(t instanceof HTMLElement){t.style.display="flex";let i=this.fileViewerBlock?.firstElementChild;i instanceof HTMLElement&&(i.style.display="none")}}}insertAppBlock(e){e&&(console.log("element:",e),e.insertAdjacentHTML(self.upfile.settings.cartInjectionPosition||"beforeend",self.upfile.settings.customHTML||""))}isInAppBrowser(){let e=navigator.userAgent||navigator.vendor;return/FBAN|FBAV|Instagram|Line|Twitter|Snapchat|TikTok/i.test(e)}openInDefaultBrowser(){let e=window.location.href,t=window.open(e,"_blank");(!t||t.closed||typeof t.closed>"u")&&alert("Please open this page in your browser for the best experience.")}togglePlaceholderUI(){this.fileViewerPlaceholder&&(self.upfile.fileViewerUIMap.size===0?this.fileViewerPlaceholder.style.display="flex":self.upfile.fileViewerUIMap.size===1&&(this.fileViewerPlaceholder.style.display="none"))}addVariantProps(e){this.productForm&&(this.hiddenInput=this.productForm.querySelector("input[name='properties[__upfile_id]']")),this.hiddenInput?this.hiddenInput.value+=`,${e}`:(this.hiddenInput=document.createElement("input"),this.hiddenInput.type="hidden",this.hiddenInput.name="properties[__upfile_id]",this.hiddenInput.value=e,this.productForm?.appendChild(this.hiddenInput))}renderFileViewerItem(e){let t=this.fileViewerOriginalRow?.cloneNode(!0);if(console.log("START newRowEl:",t),!t||t===null)return;t.dataset.id=e.id;let i=t.querySelector("[data-name]");i&&(i.textContent=e.name);let l=t.querySelector("[data-size]");l&&(l.textContent=self.upfile.formatToByteStr(e.size));let r=t.querySelector("[data-trash]");r&&(r.dataset.id=e.id,r.addEventListener("click",s=>{let a=s.target.dataset.id;a&&this.handleFileDelete(a)})),console.log("END newRowEl:",t),this.fileViewerList?.appendChild(t),t.style.display="grid",t.style.opacity="1",self.upfile.fileViewerUIMap.set(e.id,t),this.togglePlaceholderUI(),this.hideLoadingSpinner(e.id)}deleteFileViewerItem(e){if(!this.fileViewerList)return;let t=self.upfile.fileViewerUIMap.get(e);self.upfile.fileViewerUIMap.delete(e),this.fileViewerList.removeChild(t)}updateTallyElementText(){this.dropzoneFileSizeTally&&(this.dropzoneFileSizeTally.textContent=self.upfile.formatToByteStr(self.upfile.totalStateFileSize))}resetDragUI(){!this.dropzoneSelectBtn||!this.dropzoneBlock||!this.dropzoneText||(this.dropzoneSelectBtn.style.display="flex",this.dropzoneBlock.removeAttribute("data-status"),this.dropzoneBlock.removeAttribute("data-drag"),this.dropzoneText.style.display="none",this.dropzoneText.removeAttribute("data-status"))}hideLoadingSpinner(e){if(!this.fileViewerList)return;let t=this.fileViewerList.querySelector(`[data-id="${e}"]`);t&&(t.style.display="none")}renderLoadingSpinner(e){if(!this.loadingSpinner)return;let t=this.loadingSpinner.cloneNode(!0),i=e.parentNode,l=e.nextSibling;if(!(!i||!l))return e.remove(),i.insertBefore(t,l),function(){t.remove(),i.insertBefore(e,l)}}renderFileViewerSpinners(e,t){if(!this.fileViewerOriginalRow||!this.fileViewerList)return;let i=this.fileViewerOriginalRow.cloneNode(!0);i.id=e,i.classList.remove("hidden");let l=i.querySelector(".upfile__fileviewer_item_name"),r=i.querySelector(".upfile__fileviewer_item_status");l&&(l.textContent=self.upfile.fileStateObj[e].name),r&&(r.textContent="uploading...",r.setAttribute("data-status","uploading"));let s=i.querySelector(".upfile__fileviewer_trash_icon");s&&s.addEventListener("click",()=>{this.fileViewerList?.removeChild(i),self.upfile.deleteFileState(e),self.upfile.deleteVariantProps(e),this.togglePlaceholderUI(),this.updateSizeTallyUI()}),this.fileViewerList.insertBefore(i,this.fileViewerPlaceholder),self.upfile.fileViewerUIMap.set(e,i)}renderErrorMessages(e){!this.fileViewerErrorList||!this.fileViewerErrorItem||(this.fileViewerErrorList.innerHTML="",e.forEach(t=>{if(!this.fileViewerErrorItem)return;let i=this.fileViewerErrorItem.cloneNode(!0);i.classList.remove("hidden"),i.textContent=t,this.fileViewerErrorList?.appendChild(i)}),this.fileViewerErrorList.style.display="block")}updateSizeTallyUI(){this.dropzoneFileSizeTally&&(this.dropzoneFileSizeTally.textContent=self.upfile.formatToByteStr(self.upfile.totalStateFileSize))}resetErrorMessageList(){self.upfile.errorMessages=[],this.fileViewerErrorList&&(this.fileViewerErrorList.innerHTML="")}initEventListeners(){this.dropzoneBlock?.addEventListener("dragenter",this.handleDragEnter.bind(this)),this.dropzoneBlock?.addEventListener("dragover",e=>{e.preventDefault()}),this.dropzoneBlock?.addEventListener("dragleave",this.handleDragLeave.bind(this)),this.dropzoneBlock?.addEventListener("drop",this.handleDrop.bind(this)),this.dropzoneSelectBtn?.addEventListener("click",e=>{e.preventDefault(),this.dropzoneFileInput?.click()}),this.dropzoneFileInput?.addEventListener("change",e=>{let t=e.target,i=Array.from(t.files?.length?t.files:[]);this.prepareForPost(i),self.upfile.postFiles(self.upfile.formData)})}prepareForPost(e){this.resetErrorMessageList();let t=e.filter(i=>self.upfile.validateSubmittedFile(i));if(self.upfile.errorMessages.length>0||t.length===0)return self.upfile.errorMessages;Array.from(t).forEach((i,l)=>{if(!self.upfile.validateSubmittedFile(i)){this.renderErrorMessages(self.upfile.errorMessages);return}let r=crypto.randomUUID();self.upfile.addFileState(r,i),self.upfile.formData.append("file_uuid",r),self.upfile.formData.append("files",i),this.renderFileViewerSpinners(r,l)})}handleFileResponse(e,t){this.renderFileViewerItem(self.upfile.fileStateObj[e.id]),self.upfile.updateFileStatus(e.id,t)&&(this.addVariantProps(e.id),this.updateTallyElementText())}handleFileDelete(e){self.upfile.deleteVariantProps(e),this.deleteFileViewerItem(e),self.upfile.deleteFileState(e),this.updateTallyElementText(),self.upfile.errorMessages=[],this.togglePlaceholderUI(),self.upfile.deleteFiles([e])}handleDragEnter(e){if(e.preventDefault(),this.dropzoneBlock?.setAttribute("data-drag","dragging"),!this.dropzoneSelectBtn||!this.dropzoneText)return;this.dropzoneSelectBtn.style.display="none";let t=e.dataTransfer?.items;if(!t)return;let i=t.length,l="";for(let r of t){let s=self.upfile.validateDraggedFile(r);this.dropzoneBlock?.setAttribute("data-status",s?"valid":"invalid"),this.dropzoneText?.setAttribute("data-status",s?"valid":"invalid"),l=i>1?this.dropzoneText.dataset[s?"validTextPlural":"invalidTextPlural"]:this.dropzoneText.dataset[s?"validTextSingular":"invalidTextSingular"],this.dropzoneText.textContent=l,this.dropzoneText.style.display="flex",console.log("this.dropzoneText.textContent:",this.dropzoneText?.textContent)}}handleDragLeave(e){e.preventDefault(),this.resetDragUI()}async handleDrop(e){e.preventDefault(),e.stopPropagation(),this.resetDragUI();let t=e.dataTransfer?.files;if(!t)return;this.prepareForPost(Array.from(t));let{data:i,error:l}=await self.upfile.postFiles(self.upfile.formData);if(l||!i){console.warn("Upload error:",l);return}i.forEach(({value:r,status:s})=>{this.handleFileResponse(r,s)})}};function d(){console.log("UPFILE initUpfile() called"),self.Shopify?(new o,console.log("App Bridge created and mounted"),self.dispatchEvent(new CustomEvent("upfile:loaded"))):console.warn("Upfile could not get self.Shopify")}self.addEventListener("DOMContentLoaded",d);self.addEventListener("shopify:section:load",d);var o=class{#e;#i="apps/dropzone";#t=null;settings={maxFileSize:null,maxRequestSize:null,subscriptionPlan:null,forbiddenFileTypes:[".js",".exe",".bat",".sh",".php",".html",".bin"],appBridgeEnabled:null,themeBlockEnabled:null,upfileWidgets:[]};#l=null;hiddenInput=null;errorMessages=[];fileNameSet=new Set;fileViewerUIMap=new Map;fileStateObj={};totalStateFileSize=0;formData=new FormData;cart=null;constructor(){if(self.upfile=this,this.#e=`${self.Shopify.shop}/${this.#i}`,this.getMerchantSettings(),this.getCart(),self.upfile.settings.themeBlockEnabled!==!1)if(!self.location.pathname.includes("/products/")&&!self.location.pathname.includes("/cart")){console.error("Upfile: current path is NOT on a /products or /cart route");return}else self.location.pathname.includes("/products/"),this.initializeAppBridgeEvents(),self.dispatchEvent(new CustomEvent("upfile:loaded"))}injectShadowRoot(){}injectStylesheet(){}async getCart(){let e=await fetch(`${self.Shopify.routes.root}cart.js`).then(t=>t.json());this.cart=e||{}}async getMerchantSettings(){try{let e=await fetch(`${this.#e}/merchant`);if(!e.ok)throw new Error("Failed to fetch merchant settings");let t=await e.json();console.log("data:",t),self.upfile.settings={...t.settings},self.upfile.#t=t.upfilePublicStorefrontAccessToken,console.log("self.upfile.#ACCESS_TOKEN:",self.upfile.#t)}catch(e){return console.error("Could not get merchant settings:",e),null}}async addToCart(e){try{let t=await fetch(`${self.Shopify.routes.root}cart/add.js`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({items:e})});if(!t.ok)throw new Error(`Failed to add to cart: ${t.status}`);let i=await t.json();return console.log("Add to cart response:",i),i}catch(t){return console.error("addToCart() error:",t),null}}async updateCart(e,t,i){try{let l=await fetch(`${this.#e}/cart/update.js`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({operation:"updateCart",input:{cartId:e,lines:[{id:t,quantity:i}]}})});if(!l.ok)throw new Error(`Failed to update cart: ${l.status}`);let r=await l.json();return console.log("Update cart response:",r),r}catch(l){return console.error("updateCart() error:",l),null}}async postFiles(e){try{let t=await fetch(`${this.#e}/file`,{method:"POST",redirect:"manual",body:e,headers:{"Content-Length":self.upfile.totalStateFileSize.toString()}});if(!t.ok){let i=await t.text();throw new Error(`Upload failed (${t.status}): ${i}`)}return await t.json()}catch(t){return console.error("postFiles():",t),{data:null,error:t.message}}}async deleteFiles(e){try{let t=await fetch(`${this.#e}/file`,{method:"DELETE",redirect:"manual",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){let l=await t.text();throw new Error(`Delete failed (${t.status}): ${l}`)}let i=await t.json();return i.length>0&&console.warn("Some files failed to delete:",i),{failed:i}}catch(t){return console.error("deleteFiles():",t),{failed:[],error:t.message}}}addFileState(e,t){self.upfile.fileStateObj[e]={id:e,name:t.name,size:t.size,type:t.type,status:null},self.upfile.fileNameSet.add(t.name),self.upfile.totalStateFileSize+=t.size}updateFileStatus(e,t){if(!Object.hasOwn(self.upfile.fileStateObj,e))return console.error(`File with id: ${e} does not exist in state`),!1;let i=t==="fulfilled"||t==="success"?"success":"failed";self.upfile.fileStateObj[e].status=i;let l=self.upfile.fileViewerUIMap.get(e)?.querySelector("[data-status]");return l&&(l.textContent=i,l.dataset.status=i),!0}deleteFileState(e){let t=self.upfile.fileStateObj[e];self.upfile.totalStateFileSize-=t.size,self.upfile.fileNameSet.delete(t.name),delete self.upfile.fileStateObj[e],self.upfile.fileViewerUIMap.delete(e)}deleteVariantProps(e){if(this.hiddenInput){let t=this.hiddenInput.value.split(",").filter(i=>i!==e).join(",");this.hiddenInput.value=t}}validateSubmittedFile(e){return self.upfile.errorMessages=[],Object.hasOwn(self.upfile.settings.permittedFileTypes||{},e.type)||this.errorMessages.push(`'${e.name}' is an invalid file type: (${e.type})`),self.upfile.settings.maxFileSize!==null&&self.upfile.settings.maxRequestSize&&(e.size>self.upfile.settings.maxFileSize&&this.errorMessages.push(`'${e.name}' exceeds the max size by: ${this.formatToByteStr(e.size-self.upfile.settings.maxFileSize)}`),this.fileNameSet.has(e.name)&&this.errorMessages.push(`'${e.name}' is a DUPLICATE file name`),this.totalStateFileSize+e.size>self.upfile.settings.maxRequestSize&&self.upfile.errorMessages.push(`'${e.name}' exceeds combined permitted size`)),self.upfile.errorMessages.length===0}validateDraggedFile(e){return self.upfile.settings.permittedFileTypes?Object.hasOwn(self.upfile.settings.permittedFileTypes,e.type):!1}formatToByteStr(e){let t=e,i=["B","KB","MB","GB"],l=0;for(;t>=1024&&l<i.length-1;)t/=1024,l++;return`${t.toFixed(2)} ${i[l]}`}initializeAppBridgeEvents(){document.addEventListener("cart:updated",e=>{console.log("ev:",e)})}};self.addEventListener("upfile:loaded",()=>{new n});
