"use strict";class FileUpload{constructor(){if(this.fileViewerList=document.getElementById("upfile__fileviewer--item-list"),this.fileViewerOriginalRow=document.getElementById("upfile__fileviewer--item-row"),console.log("this.fileViewerOriginalRow:",this.fileViewerOriginalRow),this.fileViewerPlaceholder=document.getElementById("upfile__fileviewer--trash-icon"),this.fileViewerPlaceholder=document.getElementById("upfile__fileviewer--item-status"),!this.fileViewerList){const e=document.createElement("span");throw e.textContent="Add fileviewer block to product form and refresh page",document.body.appendChild(e),new Error("Fileviewer block not found")}this.form=document.querySelector('[data-type="add-to-cart-form"]'),this.manualFileInputEl=document.getElementById("upfile__manual-file-input"),this.selectFileBtn=document.getElementById("upfile__select-file-btn"),this.dropzoneWrapper=document.getElementById("upfile__dropzone-wrapper"),this.dropzoneText=document.getElementById("upfile__dropzone-text"),this.toastContainer=document.getElementById("upfile__toast-container"),this.fileState={allValid:null,types:[]},this.canSubmit=!0,this.fileNameSet=new Set,this.fileViewerRowState=new Map,this.fileStateObj={},this.SHOPIFY_APP_PROXY_URL="https://custom-component-portfolio.myshopify.com/apps/dropzone",this.MAX_FILE_SIZE=20*1024*1024,this.VALID_FILE_TYPES={},this.initEventListeners(),this.getMerchantSettings()}addFileState(e,t){console.log("file:",t),this.fileStateObj[e]={name:t.name,size:t.size,type:t.type,status:null}}setFileValid({type:e,valid:t}){this.fileState.types=e,this.fileState.allValid=t}deleteFileState(e){if(!this.fileStateObj[e])return;console.log("file state check:",this.fileStateObj),console.log("id:",e);const{[e]:t,...r}=this.fileStateObj;this.fileStateObj=r,console.log("File removed!",this.fileStateObj)}showErrorMessages(e){console.log("errMsgArr:",e),this.toastContainer.innerHTML="";const t=4;if(e.slice(0,t).forEach(i=>{const s=document.createElement("div");s.id="upfile__toast-text",s.textContent=i,this.toastContainer.appendChild(s)}),e.length>t){const i=document.createElement("div");i.id="upfile__toast-text",i.className="toast-message",i.innerText="... and more",i.style.backgroundColor="rgba(0, 0, 0, 0.75)",i.style.color="white",i.style.padding="10px 20px",i.style.borderRadius="5px",i.style.boxShadow="0 2px 10px rgba(0, 0, 0, 0.3)",this.toastContainer.appendChild(i)}setTimeout(()=>{this.toastContainer.innerHTML=""},3e3)}validateFile(e){console.log("file:",e);const t=[];return Object.hasOwn(this.VALID_FILE_TYPES,e.type)?e.size>this.MAX_FILE_SIZE?(t.push(`File too large: ${e.name}`),!1):this.fileNameSet.has(e.name)?(t.push(`Duplicate file: ${e.name}`),!1):(t.length>0&&this.showErrorMessages(t),this.dropzoneWrapper.removeAttribute("data-status"),this.dropzoneText.removeAttribute("data-status"),!0):(t.push(`Invalid file type: ${e.name}`),!1)}getFileFormatString(e){let t=e/1024,r="KB";return t>=1024&&(t=t/1024,r="MB"),t>=1024&&(t=t/1024,r="GB"),`${t.toFixed(2)} ${r}`}isFileNameUnique(e){this.fileNameSet.has(e)}hideFileViewerPlaceholder(){this.fileViewerPlaceholder.style.display="none"}cloneFileViewerItem(e){const t=this.fileViewerOriginalRow.cloneNode(!0);return t.dataset.id=e,t.querySelector(""),this.fileViewerList.insertAdjacentElement("beforeend",t),this.fileViewerRowState.has(e)||this.fileViewerRowState.set(e,t),console.log("this.fileViewerRowState:",this.fileViewerRowState),t.querySelector("#upfile__fileviewer--trash-icon").addEventListener("click",r=>{console.log("ev:",r),console.log("ev.target.dataset.id:",r.target.dataset.id),this.removeFileViewerItem(r.target.dataset.id)}),console.log("newRowEl:",t),t}renderFileViewerItem(e,t){const r=this.cloneFileViewerItem(e,t);this.hideFileViewerPlaceholder()}removeFileViewerItem(e){const t=this.fileViewerRowState.get(e);console.log("removableEl:",t),this.deleteFileState(e),this.fileViewerList.removeChild(t),this.fileViewerRowState.size>0&&this.hideFileViewerPlaceholder()}addVariantProperties(e){const t=e.map(({id:i})=>i).join(",");console.log("uuidStr:",t);let r=document.getElementById("input[name='properties[__file_id]']");r?r.value+=`,${t}`:(r=document.createElement("input"),r.type="hidden",r.name="properties[__file_id]",r.value=t,this.form.appendChild(r))}deleteVariantProperties(e){const t=document.querySelector("input[name='properties[__file_id]']");if(t){const i=t.value.split(",").filter(s=>s!==e).join(",");t.value=i,i||t.remove()}}async getMerchantSettings(){try{const e=await fetch(`${this.SHOPIFY_APP_PROXY_URL}/merchant`,{method:"GET"});if(!e.ok)throw new Error(`Failed to fetch settings: ${e.statusText}`);const t=await e.json();this.VALID_FILE_TYPES=t.fileTypeMap||[];return}catch(e){return console.error("getMerchantSettings() error:",e),null}}async postFiles(e){const t=e.filter(i=>this.validateFile(i)),r=new FormData;t.forEach(i=>{const s=crypto.randomUUID();r.append("file_uuid",s),r.append("files",i),this.addFileState(s,i),this.fileNameSet.add(i.name),this.renderFileViewerItem(s,i)});try{const i=await fetch(`${this.SHOPIFY_APP_PROXY_URL}/file`,{method:"POST",redirect:"manual",body:r});if(i.ok){const s=await i.json();this.addVariantProperties(s.files)}}catch(i){console.error("postFiles() error:",i)}}async deleteFiles(e){}async postErrorLogs(e){const t={message:e.message,stack:e.stack,url:window.location.href,userAgent:navigator.userAgent,timestamp:new Date().toISOString()};fetch(`${this.SHOPIFY_APP_PROXY_URL}/error`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).catch(console.error)}initEventListeners(){this.dropzoneWrapper.addEventListener("dragenter",this.handleDragEnter.bind(this)),this.dropzoneWrapper.addEventListener("dragover",e=>e.preventDefault()),this.dropzoneWrapper.addEventListener("dragleave",this.handleDragLeave.bind(this)),this.dropzoneWrapper.addEventListener("drop",this.handleDrop.bind(this)),this.selectFileBtn.addEventListener("click",e=>{e.preventDefault(),this.manualFileInputEl.click()}),this.manualFileInputEl.addEventListener("change",e=>{const t=Array.from(e.target.files);this.postFiles(t)})}handleDragEnter(e){e.preventDefault();for(const t of e.dataTransfer.items)this.validateFile(t)?(console.log("item:",t),this.setFileValid({type:[t.type],valid:!0}),this.dropzoneWrapper.setAttribute("data-status","valid"),this.dropzoneText.setAttribute("data-status","valid")):(this.setFileValid({type:[t.type],valid:!1}),this.dropzoneWrapper.setAttribute("data-status","invalid"),this.dropzoneText.setAttribute("data-status","invalid")),this.dropzoneWrapper.setAttribute("data-drag","dragging");console.log("this.fileState:",this.fileState),console.log("this.dropzoneWrapper:",this.dropzoneWrapper)}handleDragLeave(e){e.preventDefault(),this.setFileValid({type:[],valid:null}),this.dropzoneWrapper.removeAttribute("data-status"),this.dropzoneText.removeAttribute("data-status"),console.log("this.fileState:",this.fileState),console.log("this.dropzoneWrapper:",this.dropzoneWrapper)}handleDrop(e){e.preventDefault(),e.stopPropagation(),this.postFiles(Array.from(e.dataTransfer.files))}}document.addEventListener("DOMContentLoaded",()=>{new FileUpload,console.log("7")});
